# Исследование API системы мониторинга Призрак

## Обнаруженные API endpoints

### 1. Авторизация
- **URL**: `POST https://monitoring.tecel.ru/passport/api`
- **Описание**: Авторизация пользователя
- **Формат**: JSON-RPC 2.0
- **Метод**: `Authorization`
- **Заголовки**:
  - `Content-Type: application/json`
  - `X-VToken`: Base64-кодированный JSON с fingerprint и версией приложения
- **Запрос**:
```json
{
  "jsonrpc": "2.0",
  "id": 1765700322145,
  "method": "Authorization",
  "params": {
    "login": "email@example.com",
    "password": "password",
    "forever": true,
    "language_code": "RU"
  }
}
```
- **Ответ**: 
  - Заголовок `X-AToken`: зашифрованный токен для дальнейших запросов
  - Cookie `sessionId`: идентификатор сессии
  - JSON с `session_id` и информацией о пользователе
- **Примечание**: X-AToken приходит в заголовках ответа и используется для авторизации SignalR соединения

### 2. SignalR Hub для управления
- **URL**: `POST https://monitoring.tecel.ru/api/Control/negotiate?negotiateVersion=1`
- **WebSocket**: `wss://monitoring.tecel.ru/api/Control`
- **Описание**: Real-time подключение для получения обновлений состояния и отправки команд
- **Токен доступа**: Передается в параметре `access_token` при подключении WebSocket
- **Формат токена**: JSON объект с полями:
  - `Type`: число (2154785295)
  - `Atoken`: зашифрованная строка
  - `ClientData`: информация о клиенте
  - `Lang`: язык интерфейса

### 3. Сессия
- **Cookie**: `sessionId` (UUID формат)
- **Пример**: `sessionId=019b1bce-3b66-7878-bd2d-8e8bddf4a036`

## Обнаруженные функции управления

На основе интерфейса обнаружены следующие функции:

1. **Охрана** - управление состоянием охраны
2. **Автозапуск** - управление автозапуском двигателя
3. **Предпусковой подогреватель** - управление подогревом
4. **Heat'n'Start** - функция подогрева
5. **Сезонный комфорт** - климат-контроль
6. **Вентиляция** - управление вентиляцией
7. **Датчики** - просмотр состояния датчиков
8. **Поиск** - поиск автомобиля
9. **Сервисный режим** - включение/выключение сервисного режима
10. **Блокировка** - блокировка двигателя
11. **Тревога** - управление тревогой
12. **Регистратор** - управление видеорегистратором
13. **Багажник** - управление багажником
14. **Запросить местоположение (LBS)** - запрос местоположения через LBS

## Данные о состоянии автомобиля

Обнаружены следующие параметры состояния:

- **Баланс** - баланс счета (₽)
- **Температура**:
  - За бортом
  - Двигатель
  - В салоне
- **Напряжение** - напряжение аккумулятора (В)
- **Обороты** - обороты двигателя (об/м)
- **Топливо** - уровень топлива (л)
- **Скорость** - текущая скорость (км/ч)
- **Пробег** - общий пробег (км)
- **Состояние** - текущее состояние (В охране, Снято с охраны и т.д.)
- **Автозапуск** - состояние автозапуска

## Технические детали

- **Версия приложения**: 1.0.165
- **Протокол**: SignalR для real-time обновлений
- **Формат данных**: JSON
- **Языки**: RU, EN, DE, GR, UK

## Исследование команд управления

### Обнаруженные методы SignalR Hub

Все команды управления отправляются через SignalR WebSocket соединение в формате JSON с разделителем `\u001e` (Record Separator).

#### Формат сообщения SignalR

```json
{
  "arguments": [<параметры>],
  "invocationId": "<уникальный_идентификатор>",
  "target": "<имя_метода>",
  "type": 1
}\u001e
```

#### Методы управления

##### 1. Сервисный режим

**Включение сервисного режима (`ValetOn`)**
```json
{
  "arguments": [{
    "device_id": 320980,
    "puk": 6477,
    "distance": 2
  }],
  "invocationId": "7",
  "target": "ValetOn",
  "type": 1
}
```
- **device_id**: Идентификатор устройства (автомобиля)
- **puk**: PUK-код для подтверждения команды
- **distance**: Расстояние (предположительно, для проверки близости)

**Выключение сервисного режима (`ValetOff`)**
```json
{
  "arguments": [{
    "device_id": 320980,
    "puk": 6477,
    "distance": 2
  }],
  "invocationId": "9",
  "target": "ValetOff",
  "type": 1
}
```

##### 2. Автозапуск

**Включение автозапуска (`AutolaunchOn`)**
```json
{
  "arguments": [{
    "device_id": 320980
  }],
  "invocationId": "10",
  "target": "AutolaunchOn",
  "type": 1
}
```
- **device_id**: Идентификатор устройства (автомобиля)
- **Примечание**: Перед включением автозапуска требуется подтверждение через диалог "Внимание! Двигатель будет заведен!"

**Выключение автозапуска (`AutolaunchOff`)**
```json
{
  "arguments": [{
    "device_id": 320980
  }],
  "invocationId": "11",
  "target": "AutolaunchOff",
  "type": 1
}
```

##### 3. Поддержание активности соединения

**SetConnectionActivity**
```json
{
  "arguments": [{}],
  "invocationId": "8",
  "target": "SetConnectionActivity",
  "type": 1
}
```
- Используется для поддержания активности WebSocket соединения
- Отправляется периодически

##### 4. Ping сообщения

**Type 6 (Ping)**
```json
{"type":6}
```
- Отправляется периодически для поддержания соединения

### Тестирование команд (14.12.2024)

#### Сервисный режим
- **Диалог подтверждения**: При клике открывается диалог с запросом PUK-кода
- **Требования**: PUK-код находится под защитным слоем на пластиковой карте
- **Безопасность**: Команда требует дополнительной аутентификации через PUK-код
- **Метод SignalR**: `ValetOn` / `ValetOff`
- **Параметры**: `device_id`, `puk`, `distance`

#### Автозапуск
- **Диалог подтверждения**: При клике открывается диалог с предупреждением "Внимание! Двигатель будет заведен!"
- **Метод SignalR**: `AutolaunchOn` / `AutolaunchOff`
- **Параметры**: `device_id`
- **Примечание**: Автозапуск недоступен в сервисном режиме

### Выводы о механизме отправки команд

1. **Все команды управления отправляются через SignalR WebSocket соединение**
   - Не обнаружено прямых HTTP POST запросов при клике на кнопки
   - Команды отправляются после подтверждения в диалогах (если требуется)

2. **Структура процесса отправки команды**:
   - Пользователь кликает на кнопку управления
   - Открывается диалог подтверждения (для критичных команд)
   - После подтверждения команда отправляется через SignalR Hub метод `invoke()`
   - Сервер обрабатывает команду и отправляет обновление состояния обратно через SignalR

3. **Идентификатор устройства**:
   - `device_id`: 320980 (для автомобиля "Velar" в тестовом аккаунте)
   - Идентификатор уникален для каждого автомобиля

4. **Требуется дальнейшее исследование**:
   - Определить методы SignalR Hub для остальных команд (Охрана, Блокировка, Тревога, Поиск и т.д.)
   - Изучить формат ответов на команды
   - Определить методы API для получения списка автомобилей и их device_id

## Следующие шаги для изучения API

1. ✅ Изучить процесс авторизации
2. ✅ Обнаружить использование SignalR для real-time обновлений
3. ✅ Изучить интерфейс и доступные функции управления
4. ✅ Перехватить SignalR сообщения при выполнении команд (сервисный режим, автозапуск)
5. ✅ Определить методы SignalR Hub для управления (ValetOn/ValetOff, AutolaunchOn/AutolaunchOff)
6. ✅ Изучить формат команд управления и их параметры
7. ⏳ Проанализировать структуру ответов API
8. ⏳ Определить методы SignalR Hub для остальных команд (Охрана, Блокировка, Тревога, Поиск и т.д.)
9. ⏳ Определить методы API для получения списка автомобилей и их device_id
10. ⏳ Изучить методы получения данных о состоянии автомобиля через SignalR

