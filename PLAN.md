# План разработки интеграции Home Assistant для сигнализации Призрак

## Этап 1: Подготовка окружения

### 1.1 Установка зависимостей для разработки
- [ ] Установить Python 3.9+ (требование Home Assistant)
- [ ] Установить зависимости для разработки:
  - `homeassistant` (для типов и тестирования)
  - `aiohttp` (для HTTP запросов)
  - `signalr-client` или `signalr-client-aio` (для SignalR подключения)
  - `pytest` и `pytest-asyncio` (для тестирования)
  - `black`, `flake8`, `mypy` (для линтинга и форматирования)

### 1.2 Структура проекта HACS интеграции
- [ ] Создать базовую структуру:
  ```
  custom_components/
    prizrak/
      __init__.py
      manifest.json
      config_flow.py
      const.py
      api.py
      coordinator.py
      sensor.py
      switch.py
      button.py
      strings.json
  ```

## Этап 2: Изучение API

### 2.1 Авторизация
- [x] Изучить процесс авторизации через браузер
- [ ] Проанализировать запросы авторизации (headers, body, cookies)
- [ ] Определить формат токена доступа
- [ ] Реализовать функцию авторизации в Python

### 2.2 SignalR подключение
- [x] Обнаружить использование SignalR для real-time обновлений
- [ ] Изучить процесс negotiate
- [ ] Проанализировать структуру WebSocket сообщений
- [ ] Определить методы SignalR Hub
- [ ] Реализовать SignalR клиент

### 2.3 Получение данных
- [ ] Определить методы получения списка автомобилей
- [ ] Изучить формат данных о состоянии автомобиля
- [ ] Проанализировать обновления состояния в реальном времени
- [ ] Документировать все доступные параметры

### 2.4 Управление
- [ ] Перехватить запросы при выполнении команд (охрана, автозапуск и т.д.)
- [ ] Изучить формат команд управления
- [ ] Определить методы API для отправки команд
- [ ] Проанализировать ответы на команды

## Этап 3: Разработка интеграции

### 3.1 Базовые компоненты
- [ ] Создать `manifest.json` с метаданными интеграции
- [ ] Реализовать `config_flow.py` для настройки через UI
- [ ] Создать `const.py` с константами
- [ ] Реализовать `api.py` - клиент API для работы с системой мониторинга

### 3.2 Data Coordinator
- [ ] Создать `coordinator.py` для управления обновлением данных
- [ ] Реализовать периодическое обновление состояния
- [ ] Интегрировать SignalR для real-time обновлений
- [ ] Обработать ошибки и переподключение

### 3.3 Entities
- [ ] **Sensors** (`sensor.py`):
  - Состояние охраны
  - Температура (за бортом, двигатель, салон)
  - Напряжение аккумулятора
  - Обороты двигателя
  - Уровень топлива
  - Скорость
  - Пробег
  - Баланс счета
  
- [ ] **Switches** (`switch.py`):
  - Охрана (включить/выключить)
  - Автозапуск
  - Предпусковой подогреватель
  - Heat'n'Start
  - Сезонный комфорт
  - Вентиляция
  - Сервисный режим
  - Блокировка двигателя
  - Тревога
  
- [ ] **Buttons** (`button.py`):
  - Поиск автомобиля
  - Запросить местоположение (LBS)
  - Управление регистратором
  - Управление багажником

### 3.4 Конфигурация
- [ ] Создать `strings.json` для локализации
- [ ] Реализовать валидацию конфигурации
- [ ] Добавить обработку ошибок авторизации
- [ ] Реализовать обновление конфигурации

## Этап 4: Тестирование

### 4.1 Модульное тестирование
- [ ] Тесты для API клиента
- [ ] Тесты для coordinator
- [ ] Тесты для entities
- [ ] Тесты для config_flow

### 4.2 Интеграционное тестирование
- [ ] Тестирование авторизации
- [ ] Тестирование получения данных
- [ ] Тестирование отправки команд
- [ ] Тестирование SignalR подключения

### 4.3 Тестирование в Home Assistant
- [ ] Установка через HACS
- [ ] Проверка работы всех entities
- [ ] Тестирование всех функций управления
- [ ] Проверка обновлений в реальном времени

## Этап 5: Документация и публикация

### 5.1 Документация
- [ ] Создать README.md с описанием интеграции
- [ ] Добавить инструкции по установке
- [ ] Документировать все доступные entities
- [ ] Добавить примеры использования
- [ ] Создать CHANGELOG.md

### 5.2 Подготовка к публикации
- [ ] Создать репозиторий на GitHub
- [ ] Настроить HACS для автоматической установки
- [ ] Добавить иконки и скриншоты
- [ ] Подготовить release

## Текущий статус

- ✅ Создан план задач
- ✅ Начато изучение API через браузер
- ✅ Обнаружены основные endpoints
- ✅ Определены доступные функции управления
- ⏳ Продолжается изучение API

## Примечания

- API использует SignalR для real-time обновлений, что требует асинхронной реализации
- Необходимо изучить процесс авторизации более детально
- Требуется анализ структуры команд управления
- Нужно определить все доступные методы SignalR Hub

